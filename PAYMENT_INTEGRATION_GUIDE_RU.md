# Интеграция платежей TON

## Как работает система платежей TON

Когда пользователь пополняет баланс через TON:
1. Пользователь отправляет транзакцию с вашего бота в его кошельке
2. Бэкенд проверяет блокчейн на наличие входящей транзакции
3. При подтверждении транзакции - монеты добавляются на счет пользователя

## Необходимые настройки

### 1. Получить API ключ TON

Выберите один из провайдеров:

**Вариант 1: TON API (рекомендуется)**
- Зарегистрируйтесь на https://tonapi.io/
- Получите API ключ
- Используйте в переменной `TON_API_KEY`

**Вариант 2: TON Center**
- Зарегистрируйтесь на https://toncenter.com/
- Получите API ключ
- Обновите URL в `PaymentModel.ts`

### 2. Создать кошелек для получения платежей

```bash
# Создайте кошелек через:
# - TonHub
# - TonKeeper
# - MyTonWallet
# - Другой поддерживаемый кошелек
```

Получите адрес кошелька (начинается с `EQ` или `UQ`)

### 3. Настроить переменные окружения

В файле `backend/.env`:

```env
TON_API_KEY=your_api_key_from_tonapi
BOT_WALLET_ADDRESS=EQ... или UQ...
TELEGRAM_BOT_TOKEN=your_bot_token
TON_TO_COINS_RATE=1000
STARS_TO_COINS_RATE=10
```

### 4. Приложить транзакцию на фронтенде

В компоненте `Payment.tsx` или `usePaymentTON.ts` отправляйте транзакцию на `BOT_WALLET_ADDRESS`

Пример:
```typescript
const transaction = {
  validUntil: Math.floor(Date.now() / 1000) + 600,
  messages: [
    {
      address: BOT_WALLET_ADDRESS, // Адрес вашего кошелька
      amount: (userAmount * 1e9).toString(), // В nanoTON
    },
  ],
}
```

## Тестирование

### Тестовая сеть TON (Testnet)

Для тестирования используйте testnet wallet:

1. Получите testnet кошелек через https://testnet.tonviewer.com/
2. Пополните его testnet TON через кран
3. Используйте testnet API ключ
4. Тестируйте на testnet

## Как платежная система работает

### Фронтенд
1. Пользователь вводит сумму (в TON)
2. Подключается TonConnect
3. Подписывает транзакцию
4. Отправляет транзакцию в блокчейн
5. Отправляет запрос на бэкенд: `POST /payments`

### Бэкенд
1. Создает запись о платеже (статус `pending`)
2. Начинает проверять блокчейн в фоне
3. Каждые 2 секунды проверяет входящие транзакции
4. Когда находит транзакцию:
   - Обновляет статус платежа на `completed`
   - Добавляет монеты пользователю
   - Закрывает проверку

### Время проверки
- Максимальное время ожидания: 2 минуты (120 секунд)
- Интервал проверки: 2 секунды
- Максимум проверок: 60

## Коэффициенты конвертации

По умолчанию:
- 1 TON = 1000 монет
- 1 звезда = 10 монет

Вы можете изменить эти значения в переменных окружения

## Безопасность

Важные моменты:

1. **Никогда не сохраняйте приватные ключи на бэкенде**
2. **Используйте HTTPS для всех запросов**
3. **Проверяйте подпись транзакции перед добавлением монет**
4. **Ограничивайте максимальный размер платежа**
5. **Логируйте все транзакции для аудита**

## Структура БД

Таблица `payments`:
```sql
CREATE TABLE payments (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  payment_type VARCHAR(50), -- 'ton' или 'stars'
  amount DECIMAL(10, 2),
  status VARCHAR(50), -- 'pending', 'completed', 'failed'
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

## Примеры API запросов

### Создать платеж
```bash
curl -X POST http://localhost:3000/payments \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 123,
    "paymentType": "ton",
    "amount": 10,
    "userWallet": "EQUser....",
    "walletAddress": "EQYourBot...."
  }'
```

### Получить платежи пользователя
```bash
curl http://localhost:3000/payments/123
```

## Трубосос

Когда деньги поступает на адрес бота, система автоматически:
1. Обнаруживает транзакцию в блокчейне
2. Проверяет сумму и адреса
3. Добавляет монеты на счет юзера
4. Отправляет ему уведомление

**Все происходит автоматически!**
